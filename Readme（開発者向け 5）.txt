■まふ定跡の先手番勝率が高いことについて

まず定跡作成を１人で作っていると先手＋後手を作る関係上、最強の矛と盾のようにそもそも矛盾しているので、
後手番は出来るだけ自分から仕掛けて、将棋ソフトに勝率５０％を超える程度で整備しています。
※１手早く動けるということは、駒組み中であれば１手変な手を指してもまだ互角。
これを分岐の可能性に当てはめると私の定跡を作っている感覚でいえば、後手側の負担が８倍～１６倍になります。

そこまで先手が有利なのか？実戦では先手勝率５３％程度で、将棋ソフトの同ソフト対局でも同じくらいの勝率になると言われる人もいるでしょう。
絶対手を連発しないといけない超急戦を並べてみると分かりやすく、具体的な例をあげれば、
今回まふ定跡ver10では横歩を取らない相掛かり（横歩取り模様から先手が横歩を取らずに飛車を引く変化）を入れ始めました。
何故今になって入れ始めたのかについては、横歩を取らない＝飛車を何処かに戻すことであり、開発時間の問題とその引き場所に迷っていたからです。

まず前提となる超急戦を並べる必要があります。
▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛
この基本手順から

①▲２二角成 △同銀▲７七角
これは５九玉が王手飛車のラインに入るので完全に無理筋です

②ですから基本手順から先手は逆に
▲２六飛として△８八角成▲同銀△４四角と
▲５八玉として△８八角成▲同銀△３三角▲2一飛成△８八角成▲6八角の無理筋を逆に誘えます

③すぐに２六飛では横歩取りの線を放棄してしまうので、▲５八玉からの変化を見ます
▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛▲3四飛△3三角▲5八玉
こちらは横歩を取ってからの▲５八玉であり、青野流と言われ実戦例も多いかと思いますが、
▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛▲5八玉
この変化からの定跡は無いので本気出して並べてみました。
▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛▲5八玉△5二玉▲2二角成△同銀▲7七角
お互いに王手飛車を避ける▲5八玉△5二玉としてから仕掛けが成立するのか？
１ヶ月くらいで約１万手近く並べてみましたが無理筋でした。
受け側が優勢確定９８％、千日手２％となりました。
つまり後手側の応手は△５二玉で問題ありません。

④上記の結果から先手は２六飛と引くことが出来ることが分かりました。
▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛▲5八玉△5二玉▲2六飛
ここから△８八角成▲同銀△４四角では③の盤反転となる無理筋になるからです。

このように先手番で１手早く動けるということは、先手番でしか使えない戦法と後手番が使う戦法も使えるという非常に有利な条件だと思います。
人間同士の対局なら振り駒でも良いでしょうが、ミスが異常に少ないソフト対局は先手＋後手のセットで競わなければ本質的な強さは分からないと思います。

将棋は奥が深く、ただ１７手目に▲2六飛と引く１手のために約１万手近く並べる必要がありました。
ちょっと面白かったのは上記でこの筋は無理筋と確定しましたが、優勢が確定するまでに結構な手数がかかりいくつか罠を張れるルートがあったので、
そのルートをソフト各種（電王戦ＰＣスペックノードに持ち時間６０分程度の設定）に使ったところ必勝となり真逆の結果となりました。
私はこういったハメ技臭い戦法で勝敗を決するのを良しとしないので、まふ定跡ではこのルートを使う側はカットしています。
（使う側＋後手側の完全応手を共に入れていない）

まふ定跡ver10以降は先手番の約２５％程度の変化について、これを軸に追加し始めました。
大きな目的としては▲2六飛に引き、中住まい３八銀型を軸にお互いに飛車先を交換した角換わり（ほぼ千日手にならない）や、升田式ひねり飛車に近い構想等の激しい変化を追加したかったからです。



■上記④に書いた戦法は本当に無理筋なのか

一昔前なら１手のために１万手も並べるとすごいと言われたかもしれません。
しかし最近の将棋ソフトは１局面で億局面を読み、学習も億や兆といった時代です
実際に▲7六歩△3四歩▲2六歩△8四歩▲2五歩△8五歩▲7八金△3二金▲2四歩△同歩▲同飛△8六歩▲同歩△同飛▲5八玉△5二玉▲2六飛△8八角成▲同銀△4四角
この局面をＳＭ1.24で４億ノードくらい読ませ、探索深さ３０では評価値－４２とかで戦法として成立する。もしくは互角と判断しています。
これをたったの１万手並べただけで、将棋ソフトの評価が間違っていると断言出来るのか。

これについては、将棋の本質を捉えれば非常に少ない局面で正解を導き出せると思います。
将棋とは相手の王様を倒すために先手側の考える最善手と、後手側の考える最善手のぶつかり合いであって、お互いの正義しかない戦いです。

あえて棋力と表現しなかったのは、棋力という言葉は便利な言葉でなんとなく分かった気になってしまうからです。
将棋のように実質無数にある分岐の中から考える最善手はひどく曖昧なもので、個人が信じる正義という表現のほうがしっくりきます。

そもそも正義とは人の数だけ正義があるとか言われるように、定義できるようなものではありませんが、仮に定義しようとするならば悪の反対です。
つまり将棋における悪（手）を何らかの条件で定義し学習する。その反対を実行することが最善手となります。
ですから評価関数の学習において、ランダムムーブで生成したクソみたいな局面（分かりやすい悪手の定義）を混ぜて学習させたほうが学習効率が高いのでしょう。
（勾配計算が上手くいきやすいという効果も多少あると思いますが、中間層のウェイトが修正出来ているかは旧バージョンとの自己対局の勝率で確認出来ますのでおまけ程度でしょう）

超急戦のような極めて少ない局面で優劣が決する局面において明確に悪形を定義出来る場合では、その局面から予想される悪形を目指す＋避けるように試すほうが、
圧倒的に早く正解にたどり着きますので１万手で結論を得られたということです。（df-pn探索の詰みを悪形に置き換えるイメージ）
ただし通常局面のように明確な正解が無く、個人によって違う最善手のような曖昧な指し手を求める場合では一般のαβ探索のほうが上でしょう。

※探索深さ３０では戦法として成立する。と将棋ソフトは間違った判断をしているので、そもそも△５二玉とはせず偶然にこの筋は回避するのかも？
代替で△７六飛、△４二玉、△６二玉がありますが、個人的にあまり良い応手とは思えませんが。



■では何故ソフト対局で無理筋が真逆の必勝となってしまったのか

私は近年の将棋ソフトにおける最も大きなブレイクスルーを将棋の潜在的機構の特徴をＫＰＰと定義し、
そのパラメータをプロ棋士の棋譜の中から教師有り学習として出力してみせた（プロ並みの棋力で）Bonanzaだと思います。
現在はその公開された思想を元に進歩している状態で、直近ではプロ棋士＋floodgateの棋譜の中から得られたパラメータでは、
実質無数にある分岐を持つ将棋を十分に表現することが全然出来てなかったことに気がつき、王様を倒す道筋という曖昧で複数存在する出力の中で、
得られる報酬が一番高くなるような行動を選択するように強化学習をしている状態だと思います。
そのひとつが「雑巾絞り」であって、現段階で８０億人（局面）の中からランダムムーブで生成される「モヒカン＋トゲトゲ肩パット」のように、
あきらかにコイツ悪いヤツだろうと分かりやすい悪（手）の定義を混ぜ込み、機械が理解しやすい状態にして学習効率を上げて最善手を学習していますが、
何度も同じような定義ばかりで学習していれば何処かの近似値で収束（雑巾が絞れなくなる）するでしょう。
これはこれで全体から見て平均値の高い（大多数が満足する）最善手の学習結果なので、定義を大きく変えてしまっては弱くなってしまうと思います。
（Aperyの評価関数を強化学習する企画は、普段将棋を指しているだけではまったく縁の無い、人工知能が学習し成長する過程を身近に体験出来たので非常に面白かった）

だからといって、８０億人（局面）の中から今度は「普段はおとなしい子なのに」「まさか。あの子に限って」といった一見して分からない悪（手）の特徴を見つけ、学習をすることが出来るのか。
その手法のひとつは、少し悪いものを混ぜてみる。
レーティングがちょっと低いソフトから生成された棋譜＝技巧よりＲが上なら技巧から生成された棋譜とか、
旧バージョンのほうがレーティングが低ければ、そこから生成された棋譜とか、
このような手法によって雑巾がさらに絞れる可能性があると思いますが、どれほどの効果があるか分かりませんし混ぜ込む適正量を調べるのも大変です。

評価関数は上記のような機械学習における弱点というか特性が存在するため、全体の平均値は高くても局地的なレベルはたいしたことがない場合が普通です。
ゆえに本当は無理筋なのにソフトに対しては必勝となってしまったのでしょう。



■定跡作成過程で現在の評価関数は序盤をどのくらい理解しているのか表現してみると

まふ定跡は作成スタート時に未調整のまま技巧に定跡登録し、浮かむ瀬定跡ＯＦＦと対局したところ勝率１０％でした。
（技巧ノーマルの勝率が２５％程度だったと思いますのでＲ－１９０と下がり、この先がんばったところでプロジェクト的に失敗臭しかしない状態でした）

その後、過去のReadmeに書いたようにuuunuuunさんの対技巧Ｒ測定５ｓ↑で、技巧が指した３１５０局の中から上手く指した棋譜１６％の５００局と、
棋譜提供を受けた複数人の中で特定の１０００局を絶対手として削り込み（採用率の調整）を行いました。
その結果、対技巧ノーマルに対してＲ＋８７となりましたので、未調整状態からはＲ＋２８０くらいになりました。

今思えば作成当初はまったく意識していませんでしたが、アマ強豪の棋譜から作成したことで程よく悪手が混ざった状態の序盤教師局面となっていたようです。
スタート時では約６００万手をツリー化していたので、重複を除けば２５０万手程度の局面数で、採用率が入っているのが１３０万手程度の序盤教師局面となっていました。
これを上記のやり方で意図せず「教師あり学習」と同じことを人力でやっていたようです。

序盤教師局面１３０万手の中から特定の（５００局＋１０００局）×６０手目＝９万手、このうち重複を除けば約５万手を好手の特徴と定義し、
このルート局面を入力１、その局面の指し手を絶対手（他の手を採用率０）にする出力１としたので、教師あり学習の過学習状態とした。
※この時点で採用率が入っている指し手は１２０万手以下となり、調整済み有効手約５万手という状態です。
棋譜の提供を受けたので局面生成はしていませんし、Ｒ測定はuuunuuunさんにやって頂きましたが、空いた時間を使った１０日間の手作業でした。

技巧の定跡は超えましたが、まだ浮かむ瀬定跡ＯＦＦは超えていませんでした。
浮かむ瀬定跡ＯＦＦを超えたのはVer３のuuunuuunさんによる、定跡有り無しの同ソフト対局の計測でした。
Ver１～３までにやったことは過去のReadmeに書いたように、uuunuuunさんがＲ計測を行った棋譜生成から負けたルートの削り込みです。
勝った棋譜のルートはたくさん選択するように１０倍化して採用率を増やしました。
これが今考えると「強化学習」と同じことを人力でやっていたようです。

Ver１では技巧ノーマルに負けた１１３局（３４６局中）と、浮かむ瀬定跡ＯＦＦに負けた１４８局（２４５局中）だったと思います。
このときは悪手が多数あって、場当たり的に修正しVer２としました。
Ver２を用いた対局棋譜からVer１と同様の修正を行なっていたところ、対浮かむ瀬定跡ＯＦＦの角換わり勝率が異常に低いという悪い特徴を見つけたので、
その局面を追加修正しVer３としました。

つまりまったく意図していませんでしたが、評価関数と同じ作りを人力で作成していたようです。

ここまでに修正した指し手は約１０万手だったと思います。
※ver７の指し手調整済み有効手約１８万手（シンプル合議将棋とかを開発されているtttakさんから数を調べて頂いたメール）より逆算してみた

８０億局面なんて数を何回も強化学習した評価関数を、たったの１０万手調整するだけで何故超えれたのか。

普通に考えれば初手７六歩は２０駒手番有りの１パラメータであり、すさまじい数の対局実績があるのでαβ探索の探索深さ５０は軽くあるでしょう。
ＫＰＰＰＰＰＰＰＰＰＰＰＰＰＰＰＰＰＰＰＴの探索深さ５０と、ＫＰＰＴ探索深さ３０を比べるようなものです。
ですから今のＫＰＰＴ型の将棋ソフトが探索する超序盤の評価値は、無理やり当てはめているだけのものであって将棋ソフトもどっちが良いかなんて分かっていません。



■評価関数と同じような作りを人力でやってみた結果から評価関数を作るとしたら

①振り飛車は学習しない。
これは振り飛車がダメな戦法というわけではなく、振り飛車は基本自分から急戦を仕掛ける戦法でないため、今の探索部の精度と標準使用ハードが力を発揮出来る手数まで
局面が伸びることから、居飛車で学習した評価関数でも対応出来ることが理由です。
※言い変えれば今の評価関数は以前の物より振り飛車の棋力が最も上がっていると言えます。

②教師局面の比率を４０手目～７０手目間が一番多くなるようにする。
これは普通に将棋を指していたら気づくことですが、このポイントが最も優劣を決める勝負手が発生する確率が高いからです。

③探索打ち切りの評価値を１０００くらいにする。
Aperyが３０００？だったと思いますが、機械が理解しやすい状態にして学習効率を上げる効果を狙うなら最初の数回までだと思います。
上記の②に思想が近いと思いますが、もっと学習するポイントを要点に近づけるため。

④教師局面を生成する初期局面をある程度決めてしまう。
単純に学習するポイントをある程度決めて必要な教師局面を減らすことや、自己対局でのパラメータ修正を確認しやすく（定跡勝率のブレを減らす）するため。

現在の評価関数における機械学習は人工知能の分野を参考に過学習を防ぎ、出来るだけ未知の入力（局面）から王様を倒すという出力に向かって学習していますが、
将棋の初期配置は決まっており平手なら入力は１つしかありえません。

このように将棋は構造上、大きく分けて序盤、中盤、終盤で必要な特徴量が全然違います。

序盤・・・初期局面の入力１に、王様を倒す道筋という曖昧で複数存在する出力
中盤・・・確率的に未知の局面という複数の入力に、王様を倒す道筋という曖昧で複数存在する出力
終盤・・・確率的に未知の局面という複数の入力に、王様を詰ますという出力１（入玉宣言は確率的に無視する）
※しかもルール上後退出来る駒が存在するので千日手縛りの中で無限の組み合わせがある

囲碁は初期局面の入力１に、陣地を多く取るという出力１の特徴量を発見し学習すればいいのに対して、
将棋は上記のような構造を持っているので、この特徴量を発見し学習するのはどう考えても困難です。
（ただし囲碁は盤面が広すぎるため将棋のように特徴量を３駒等の定義が実質出来ず、従来の機械学習お得意の数の暴力が通用しにくい）

⑤どのような局面を学習すればいいのか
もし将棋にパーフェクトゲームがあるとするならば、後手番が回避出来ない争点を作ってしまった瞬間だと思われます。
（後手が４手目以内に角道を開けるとか＝この条件の場合ただでさえ１手遅い後手はさらに１手損か１歩損が確定してしまうからです）
※まふ定跡ではすぐに角道を開けますが、これは悪手と理解しつつ単純に選択する戦法を増やしたいからです。
（すぐに角道を開けない＝ノーマルの相掛りや角換わりといった特定の戦法しか選べなくなり、細かいポイントの取り合いばかりになるから）

定跡を作成していればすぐに気がつきますが、評価関数に合わない戦法を入れても上手くいきません。
例）横歩取りで先手が▲６八玉とすると、後手は角換わりの評価関数に引っ張られて１歩損なのに局面を落ち着かせてしまい、先手の勝率が高くなる。

全体学習ばかりを行うとこのようなことが起きるので、ある程度評価関数が頭打ちになったと思ったときは、ひたすらに数で解決するよりも
後手がすぐに角道を開けない特定の戦法を学習して、人間のように個性を目指すほうが良いと思われます。



■おまけ
上記の理屈から言えば横歩取り戦法は先手必勝と思われます。他には後手が振り飛車にしないのに△４四歩と回避不能な争点を作った場合等です。
この理屈と現在の将棋ソフトの特徴量が３駒であることを考え、まふ定跡は作成されています。

将棋ソフト同士の対局で横歩取り先手▲６八玉が強い理由
▲６八玉は５七の地点をケアしないといけないので、３駒だと▲４八銀＋▲３九金＋▲２筋の飛車が将棋ソフトの考える最強の陣形の１つです。
この陣形では後手がどんな攻めをしても受けきれるので後手が下手に攻めると先手勝勢となり、横歩を取った１歩得がそのままプラスになるからです。

まふ定跡で採用している対抗手
①角がいつでも交換出来る条件より、△５二玉＋△７二銀＋△９四歩として浮き飛車の可動域を広げる。
②▲３九金は２筋に飛車がいなくなれば△２七角打から馬を作って面制圧を狙えるので、飛車をいじめる手筋を入れる。
※あくまで△２七角打を目指すので、角を使って飛車をいじめるのは疑問手
③▲２八飛車と逃げられた場合に▲３六歩なら、１九の香車をたたいて△１九角打からの馬を作るのは好手判断より、１筋の歩を突き合わせる＋筋違い角の手筋を入れる。
④▲２六飛車のまま▲３六歩なら、△７四飛車のひねり飛車の手筋を入れる。
⑤▲４六歩なら、△７四飛車のひねり飛車の手筋と、▲４七銀と離れた場合の１筋の薄さを狙う手筋を入れる。
⑥先手が何もしないのなら２筋の逆進行。

ひとつの陣形ですら細かく言えばまだ有りますが、こういった思想のもと対抗手を定跡化していますので、この辺を学習出来れば将棋ソフトはもっと面白くなると思います。
※今の将棋ソフトは相手がミスするまで待っているだけですごくつまらない将棋に見え、ただの将棋勝率計算機のようにも感じます。
人工知能の定義のひとつとして、機械が人間のように振る舞うという点（様々な立場があるので絶対ではありませんが）においては成功しているかは疑問です。
