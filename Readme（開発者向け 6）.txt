■HoneyWaffleさんのTwitterにて

＞早石田の変化、まふ定跡対策で相手番の指し手も含んでいる。それ含んでるとライセンスを先方と揃えてGPL-3.0にしないといけないのかな

えっと、まふ定跡のGitHubがGPL-3.0については、
以前どこだったかApery開発者とうさぴょん開発者が「定跡バイナリは指し手に評価値を付けたり改良の余地があって、思考部として……」みたいなのをどこかで見ました。
なので私が配布している定跡形式はApery形式と技巧形式となっており、この定跡形式の箱の部分にひょっとしたらライセンスが引っかかるかもと思い、GPL-3.0にしています。
ですから中身の部分については、私は著作権等の制限を一切かけないのでご自由にどうぞ。
HoneyWaffleさんの配布されています定跡形式は、ただのsfen形式の.dbファイルですからGPL-3.0は必要ないと思います。
が、一番上にYANEURAOU-DB2016 1.00と書いていますので、やねうら王開発者の許可が厳密には必要かも？
まあ、やねうら王開発者は定跡形式を統一したいと考えている方なので、ライセンスどうこう言うことは無いでしょうけど。

※私はプライベートではTwitter等一切やりませんし、スマホすら持たない主義なので、こんなところにしか書けません。
誰かHoneyWaffleさんのTwitterにお伝えしていただければと思います。



■他Twitterにて

Qhapaqさん＞有志によるQhapaqとelmoの勝率みるとQhapaqの後手番が弱くて驚きます。定跡の相性かな......

rangingさん＞2スレ：0.5秒　Qhapaq（やね探索、評価関数Qhapaq、定跡Qhapaq_Z) 対elmo（やね探索、評価関数elmo、定跡elmo）の結果 
　　　　　　少なくとも100局くらいじゃ有意な差は出ない。出ないんだけど両者先手勝率が異様に高い。定跡ガチャってより振り駒ガチャだった可能性？

この辺感覚的な物が強く言語化が難しいのですが、そのうち開発過程の様子と絡めて出来るだけ説明したいと思います。



■elmo定跡について

elmo定跡については、開発の過程でまふ定跡をメタる＝結果的になぞる部分が多くなります。
これについて私は「こいつパクりやがって」なんてまったく思いません！
むしろありがたいと思っています。

なぜならReadme（開発者向け 5）の１０５行目から書いているように、
去年の技巧定跡を越えるのに１０日、その後浮かむ瀬定跡ＯＦＦを超えるのに５日で、wcsc27までの１７０日間はひたすらに自己更新しか出来なかったからです。
相手は実質「浮かむ瀬評価関数」しかこの半年間おらず、それはもう砂漠の中から黄金の一粒を見つけるような作業が延々と続くだけでしたから。
人によってはコレだけ苦労したのをパクりやがってと憤慨する人もいるかもしれませんが、私からすればelmo定跡は浮かむ瀬評価関数より強い評価関数を使って、
elmo開発者がわざわざリソースを割いて指し手選抜してくれてるのだから、これほど楽なことはありません。

これは河童全力定跡やHoneyWaffle定跡にも言えることで、もうこの３つをまふ定跡ver11に足して調整したものをver12で配布すれば良いのではないかと喜んでいます。



■tanuki-さんへ

えびちゃんの第27回世界コンピュータ将棋選手権 3日目【会場から生中継】 の再放送を見ていたんですが、
tanuki-さんのコメントで「まふ定跡のガチャを全敗している」と言っていましたので棋譜を確認してきました。

そうしましたら、おかしな指し手ばかり拾っていましたので、エンジン側の選択設定が上手くいっていなかったと思われます。

具体例）決勝 2回戦 蒼天幻想ナイツ・オブ・タヌキ - Ponanza Chainer

一発定跡（改）の９手目は、６八銀が採用率１００の勝率５４％、７八銀が採用率０．０１の勝率６０％ですが７八銀を選択しています。
１９手目は、７八金が採用率１．１６の勝率５１％、３七桂馬が採用率０．０１の勝率９８％ですが３七桂馬を選択しています。

Readme 9(技巧版ver10)を見ていただけたら分かる通り、私は手入力で指し手調整している関係で勝率がおかしくなるため、
NarrowBook＝ＯＦＦにするように注意文を記載しております。

おそらくですがこの関係で変なルートばかりに入っていっていたものだと推測しています。

Twitterにて＞蒼天幻想ナイツ・オブ・タヌキの最大のウリは、Apery定跡データベースが使えるところなんじゃないかなぁ…。
やねうら王+elmo評価関数ファイル+まふ定跡という夢のコラボが楽しめるようになるはずです…。

と書かれていましたので、配布するエンジンはどんな状態でしょうか？
（私のＰＣだとＡＶＸ２は起動しませんので、ＳＳＥ４．２対応であれば確認できますが）


【不具合報告】GitHubの使い方をマスターしていないので、とりあえずココに書いておきます

①Apery形式の定跡の読み込みがおかしい
※まずNarrowBookをＯＮにしようがＯＦＦにしようが指し手選択は変わりません＝採用率で選ぶ設定と推測します
※１局面で複数手の登録が有る場合、採用率１位、２位、３位の３手とか有る場合に最も採用率が低いものを選択します。
エンジン側の定跡採用率の選択順位が逆になっていると推測します。
（wcsc27はまふ定跡のApery形式を使用した場合、採用率の入った最も最悪な指し手ばかり選択しています。これで良く世界５位になれましたね……）

②ＳＳＥ４．２が定跡がヒットすると（定跡進行中）にエンジン停止をする
※ResignValueが原因と思います。デフォルトの99999ではエラー落ちします。3000とかに値を変更すると動きました。
（やねうら王に投了設定が付いた最初期に同様のエラーが有ったと思います）

③ＳＳＥ４．２が思考開始直後にエンジン停止をする
※こちらについてはさっぱり原因が分かりません。


tanuki-さんのTwitterにて
＞まふ様より雑記でtanuki-のApery定跡読み込みルーチンの不具合報告を頂きました。NarrowBookが反映されないバグは確認できました。
採択率が一番悪い手ばかりが採択されるバグは確認できませんでした。現在の実装では当確率で採択されるはずです。

現在私のＰＣではSSE4.2しか確認出来ないので、ShogiGUIを使用し検討モードで定跡選択順位を確認したところ、
最善手、次善手、３番手の順位がすべて採用率の低い順位で表示されていますので、逆になっていると思います。（wcsc27の定跡選択手も）
やねうら王はたしかＰＶの表示がすべて逆表示するソフトでしたが、対局中の選択手が逆になるわけではないので表示ミスは修正されていなかったと記憶しております。
この辺が定跡選択で悪さしていませんか？



■これだけは言っておきたい

【ポナに圧勝】史上最強ソフトelmo 無料公開される。を見ているとelmo定跡に不満のある方が多いようです。
それについてelmo開発者やQhapaq開発者もTwitterで悩んでいる様子を見ました。

２０１６年の電王戦では定跡ＯＦＦがトレンド。
今後は定跡とかいらないよみたいな風潮だったので、私から見れば序盤穴だらけの将棋ソフトが何の冗談だと思い、一石を投じてみました。
何にせよ口だけなら誰でも言えるし、やってみせるしかないわけで一人奮起した結果が「まふ定跡」です。

私は定跡を作成しているときに一度「将棋の５０手目までの有効手っていくつあるんだろ？」と考えたことが有ります。
私の答えは約６０００万手の組み合わせです。
人間の対局と同じ比率で局面合流すると仮定した場合１/５となりますので、５０手目までの有効手は約１２００万手です。

まふ定跡では私１人が半年かけて５０手目までは、約３０万手程度見つけて登録することが出来ました。
つまり、まふ定跡でさえたったの２％くらい解析が終わった所です。

そして作り始めた当初はいろいろ入れようと思いましたが、どうしても大会の２５６手ルール問題が有り、スピード感を追求した結果が横歩取りでした。

ただ、どんな良い物を作ったとしても知名度が無ければ普及しないし、そいうった意味では将棋レーティングサイトとして活躍されていた
uuunuuunさんの協力を得られたことは大きかったです。

それがやっと将棋ソフト開発者の目にもとまり、elmo開発者やQhapaq開発者といった人達に波及し、wcsc27になんとか間に合ったというのが現在だと思います。

そんな中「定跡？いまさら？」みたいなPonanzaが数ヶ月オープンソース勢が研鑽してきた舞台にひょっこり足を踏み入れて、elmoにフルボッコにされたのがwcsc27だったと見ています。
Ponanzaはいままで初手から意味不明な動きをして、残りの９８％の舞台で主に評価関数の差で勝っていたにすぎなかったことが判明したということでもあります。
もちろんelmo開発者の評価関数のブレイクスルーを始め、神がかったタイミングでやねうら王の探索部が改良されたり、本当にいろんなことが重なった劇的な結末だったと思います。

ですから今回の「第27回世界コンピュータ将棋選手権」の独創賞に該当者なしは意味がわかりません。
elmo定跡とQhapaq定跡の作成方法はある意味「初めてまともな将棋の定跡をコンピュータが機械導出」したのですから。
私はこの大会って【コンピュータ】将棋選手権じゃなかったの？と非常に疑問に思いました。

elmo定跡なんて将棋の定跡世界から言えば、たったの０．３％程度の赤ちゃんです。
でも機械導出できたんですよ。
コンピュータの世界なら機械導出さえ出来ればあとは計算リソースの問題だけです。

例えば、Ponanzaが次の大会で定跡外せば何とかなるだろって高を括っていれば、その間にPonanzaの棋譜等を参考にelmo、Qhapaq、tanuki-、読み太、の評価関数バイナリで
いろんな角度から有効手を機械導出して、チェスのオープニングのように共有しておけば、Ponanzaに一発入る確率が３０％以上とかのソフトがごろごろしている大会になることだってありえます。
そのくらい将棋の序盤にブレイクスルーが起きた大会だったと私は思っています。


定跡を作成している立場で言えば、elmo定跡とQhapaq定跡は性質が違います。

elmo定跡はあくまで自分の評価関数の強さに依存していて、勝率とリンクさせることによって自分の評価関数の力を最大限に発揮するように作った定跡です。
作成過程でまふ定跡のように、いろいろ有効手を試した定跡にぶつけると大幅に手間が省略できる感じです。

Qhapaq定跡は多角的にいろんな定跡をぶつけることによって、将棋の本質的に好手となる手を機械導出しようとした定跡です。
ですからQhapaq定跡は他のソフトに組み込んでもレーティングの上昇が見込めますし、今大会後に発表されたソフトから生成される棋譜を使えばさらに上が見込めます。

もちろんこれらを１人の開発者が全部やる必要は無いと思います。
チェスのようにオープニングデータベースとして共有する目的で、各開発者が協力する時代が来ても良いと思います。



■やねうら王2017-Early V4.41　強すぎ

tanuki- さんの修正が来たのでV4.41相当を使ってみましたが強すぎます。
ＳＭ１．２５＋elmoも次元の違う強さだけど、V4.41相当＋elmoはそれすら軽くひねる。

Ponanza相手にハンデ状態（低スペックハード）で勝つはずだわ。
やねうら王マジで天才。
何いじったらこんなことになるの？
探索部もいきなりブレイクスルーしてる。



■やねうら王2017-Early V4.41＋elmoがPonanzaに勝てた理由（個人的見解）

①まずelmo評価関数が何故こんなに強いのか。

アピール文書で浮かむ瀬を最適化したと書いていました。
雑記.txtの１５９行目に以前書いたんですが、floodgateのmonkeymagic（elmo）の対局を見たとき、どう見ても浮かむ瀬の進化系にしか見えませんでした。
具体的には浮かむ瀬の評価値勾配がフラットに洗練されていて、相手の学習がデコボコの評価値が出るたびに評価値が傾いていました。
つまり相手が勝手に体勢を崩していっていました。

このことから、elmo絞りは現行の評価関数の仕上げ作業が出来るのではないかと考えています。
おそらくとてつもない回数をこなすことによって、同じような状態（Ponanza）になると思いますが、それを超高効率で行えるのではないかと考えています。

②ただし大きな問題がある

上記に書いた通り、相手のミス待ちのような状態になるため、elmo対elmoや、elmo対Ponanzaなどの洗練された評価関数同士の対局となると、
ハードに差が無ければ完全に見合ってしまって手数がどんどん伸びる。（お互いが体勢を崩さないから）

ここで「やねうら王2017-Early V4.41」が活躍する。
洗練された評価関数から導出される指し手候補は似たような評価値を持つ指し手が多く、中盤指し手候補が横並びのような状態になる。
現行の探索部ではこのような状態の指し手を上手く選択出来ていない。が、やねうら王2017-Early V4.41はその辺の選択が格段に上手い。
つまり、elmo評価関数との相性が非常に良い。


Ponanza Chainerがアピール文書を出したときに、コンピュータ将棋も終わったなと絶望を振り撒いてから１ヶ月。
こんな結末が用意されているとか誰が想像したでしょうか。
実はこの日からelmo開発者がやねうら王に専用探索部の作成を依頼してました。とかのほうがよほど現実味がある。
本当に偶然出合っちゃっただけなの？



■コンピュータ将棋スレッドやTwitterを見ていると

Ponanzaがディープラーニングで失敗したみたいな書き込みを良く見る。
しかし定跡を作成している立場で言わせてもうらうと、ディープラーニングは成功しています。

Readme（開発者向け 5）の１９３行目にも書いていますが私は「横歩取り戦法は先手必勝」だと思っています。

例えば二次予選 6回戦 Ponanza Chainer - elmo
あれだけの人、金、物を投入して元世界最強の将棋ソフト開発者に「今年の世界コンピュータ将棋選手権のPonanzaはたぶんめちゃめちゃ強いことになる。
過去現在、そして下手したら今後数年の未来までも含めて史上最強の将棋プログラムになるかもしれない」とまで言わせた、
そんな将棋ソフトが選んだ戦法が「横歩取り」だったからです。

詳しい説明は省きますが私の定跡理論では、２６手目△８八角成が疑問手でPonanzaに勝ち筋が出ましたが、３３手目▲２八飛が悪手でPonanzaの負けです。
３３手目が▲７七銀でPonanzaの勝ちです。
そのくらいにこの局面が急所であって、これ以外の答えをドヤ顔で説明している人は横歩取りの経験が乏しい人です。

何故Ponanzaが悪手を指したのかについては、△４四角打が見えるのが将棋ソフトにとっては錯覚を起こすようです。
序盤の穴の１つで、最近の定跡メタゲームに参加していた開発者は分かると思います。



■結局Ponanzaってどのくらいすごいの？

第27回世界コンピュータ将棋選手権時点の個人的な見解

①評価関数
新たなブレイクスルーを達成したelmoに対して、従来手法を突き詰めたPonanza
elmo ＞ Ponanza

②探索部
新たなブレイクスルーを達成したやねうら王に対して、終盤以外は追い越されたPonanza
やねうら王　＞　Ponanza

③新技術
電王戦以降明らかになった将棋ソフトの序盤問題（欠陥）に効果があった新技術
elmo定跡　＞　Ponanzaディープラーニング
Qhapaq定跡　＞　Ponanzaディープラーニング

④クラスタ技術
クジラちゃん　＞　企業支援を受けて、専門家がチームメンバーにいたPonanza
技巧　＞　企業支援を受けて、専門家がチームメンバーにいたPonanza


私個人が見るに今大会でPonanzaが圧倒的トップだった所は見当たりませんでした。
しいて言うなら過去の実績とオープンソース化してない関係で、未だに実は最強なんじゃないの？と錯覚させるブランド力でしょうか。
もちろん社会的にはブランド力の有り無しは大きな違いがあるので、とてもすごいことだと思います。
しかしPonanzaのブランド力は強さの依存度合いが大きいので、はっきり言って崖っぷちであることは間違いありません。

某Twitterにて
＞しかしこれがアメリカだったら、瀧澤さんには年収２千万くらいの転職オファーが殺到するんだろうな…
＞びっくりするくらい簡単なことしかやってないんですよelmo。流石に恐れ多いです

といったやり取りを見ましたが、本当に将棋ソフト開発者の方々はすごい人達です。
これだけの人材が個人開発レベルで企業に応用が利きそうな実績を残しているのに、パトロンとか付かないのだろうか？



■読み太４．０を使ってみました

これ面白いですね。
ＮＰＳが半分くらいなので、相当探索に負荷がかかっている（枝を広く見ている）
まるでBonanzaを彷彿とさせるエンジンですね。
昨今のとにかくＮＰＳを伸ばそうとしているコンセプトと真逆を行くとは。
そのわりに４０００万ノード付近からは探索深さが伸びるし、ミッション車のシフトチェンジしたみたいだ。
いままでに無かったタイプの探索部ですね。
評価関数を乗せ替えてみたり、どこがおいしいノード数なのか検証してみないと。

↑めちゃくちゃ訂正
スレッド数が１になってた。
ＮＰＳはむしろ他のエンジンより出ている。
ただ、細かい挙動が変わるわけはないので、スレッド１で見た感想は変わらない。
つまり、浅いところは広く見てから途中から深く見る仕様だと思う＝終盤力は高く、読み抜けに強くなった？



■なんかもう

評価関数やら探索部やらいっぱいありすぎて自分が何使っているのかわからない。

しかも評価関数が同じでも探索部が違うと全然違う指し手を出す。
（難解な局面だとやねうらV4.41とV4.52ですら違う）

しばらくはベストマッチを探さないとダメなんじゃない？

ちなみに私のとこだと、
tanuki-評価関数＋やねV4.41　＞　elmo評価関数＋SM1.25
とかになった。
（低スペＰＣのため３日放置した結果）

tanuki-評価関数とelmo評価関数にそんな差はないと言いたかったんだけど、ここに来てエロ河童とか。



■elmo-qhapaq評価関数について

少し使ってみましたが、elmoが整えた勾配を一部大きく崩しています。

例）相掛かりでelmo定跡で▲６八玉としているのを、ある条件が揃うと▲６九玉と移動します（中原囲いにしようとする）
これはReadme 8(ＳＭ版ver10)の３９行目～４４行目に書いている状態であり、あまり良くない状態だと思われます。
もちろんこれ１つだけではなく複数存在すると思いますので、これだけクセが強くなるのであれば専用の定跡制御が必要と思われます。

※elmo評価関数が他の評価関数より圧倒的にすごい所は、定跡を抜けても指し手を自然と継続させる所です。
私は半年間とにかく当時の評価関数の序盤の悪さを矯正しようとしていたので、floodgateのmonkeymagicにまふ定跡のなぞりスナイプされたときの衝撃は忘れられません。
いままでの評価関数だと私の作った定跡を抜けても、評価関数と私の考えが違い相手にもちょっとチグハク感が出ていましたが、それが極めて小さかったからです。

私はこのReadme（開発者向け 6）の２１６行目で、
①評価関数
新たなブレイクスルーを達成したelmoに対して、従来手法を突き詰めたPonanza
elmo ＞ Ponanza

と評価しましたがより具体的に言えば、Ponanzaはいままで初手から変な手を指したり、端歩を指したり無駄な動きをしていましたが、
それでもレーティングが他のソフトより４００程度離れていたため勝ってしまっていました。
つまり邪道な部分を過学習してしまった評価関数とも言えます。
そしてココに来て優秀なスタッフを迎え、ディープラーニングが成功してしまったため、正道な動きをしようとしてしまい変な競合が起きていたと感じています。

そんな中で正道な評価関数＋定跡を突き詰めたelmoが登場してしまい、あれだけハードに差があったのに叩き潰されたのではないかと思っています。

現在の将棋ソフトはＲ４０００超えなんていう１つのミスで勝敗が左右される極地で戦っていますので、こういった学習のデコボコは命取りになりそうです。
また、途中に学習のデコボコが出来ると、探索中の始点と終点が結びつかずＰＶハマりを起こしやすくなり、ノード数が増える程に不利になると考えられます。
（MultiPV等でＰＶハマりを回避することは可能であると考えますが、上手く作れなかった物をカバーするために計算リソースを割くことになるかと）
（何故クジラちゃんが今大会、上位陣の評価関数と浮かむ瀬デフォルトで戦えたのか、クラスタ技術の優れていた点を考えると分かりやすいと思います）
逆に短い時間の探索では、相手は考えている途中で探索が終了してしまい、こちらはたまたま学習のデコボコに引っかかってその時間帯の中では、
相手より良い手でＰＶがハマり勝率が大きく出てしまうかもしれません。

このことから、あまり短い時間での測定は良くないのかもしれません。
uuunuuunさんのレーティング測定から分かるように、３００局も対局すればほぼレートが取れるので、今後はそれなりの時間を使って評価しなければダメなのかも。



■自己対局のレートの計り方

Qhapaqさんがレート測定方法で悩んでいたので１つアドバイスになれば。
現在は定跡ＯＦＦで測定する以外ありません。

その定跡型の勝率を誰も保証していませんから。

uuunuuunさんのレーティング測定で調度良い資料があります。
今回の新ソフトレート測定の「浮かむ瀬sdt4　対　elmo」これの定跡ＯＦＦでelmo後手番を見て下さい。

elmoの勝率が６０％程度だと思います（ワンサイドゲームが）
（ちなみにelmo先手は９７％）

そしてuuunuuunさんの事前レーティング測定で、elmoの定跡をＯＮにした場合はelmom後手番の勝率が６０％→１００％になっています。
（私は現在の将棋ソフトの序盤問題を何度も提唱していますが、これを見て分かる通りヒドイ物です）

新しい評価関数のレート測定も定跡ＯＦＦで、先手旧ver 対 後手新verの勝率が事前に分かっていれば、
強くなったかどうかを知るだけなら、わざわざ先後入れ替えの対局をせずとも半分で済むんじゃないですか？



■elmoの横歩取り

elmoさんのTwitterにて
＞elmoが定跡で横歩やるのはまふ定跡対策で横歩の受け手順探してた時に良くなる展開があまり無かったからで、elmoが自分で考える時には横歩やらないんですよね。

とありましたが、これは私の雑記.txtのトップに書いてる浅い探索時のソフトの特徴です。
elmo評価関数＋やねV4.55
MultiPV５の探索深さ３０の最善手は▲３四飛（＋７４）とかですね。
MultiPV５の探索深さ３２の最善手は▲３四飛（＋６１）、次善手▲６八玉（＋６１）でした。

これは他のソフトと同じなので、知っていれば特に気にもならないことですが、注目したいのはその読み筋です。
何故▲３四飛（横歩取り）を最善手としたのか、▲３四飛、△３三角、▲６八玉！

そうです、横歩取り勇気流なんですよね。
Ponanzaを倒したelmoの影響力はとてつもなく大きいでしょう。
そんなソフトが勇気流を押してくるのなら、elmo式勇気流のような戦法が今後プロの間で出てくるかもしれません。

私はPonanza Chainerと同じく（二次予選で見せた）▲５八玉派なので、時間があれば対抗を作りたいと思っています。



■定跡について

将棋ソフト開発者が勘違いしているor気付いていない点をひとつ書いておきます。

将棋の戦法定跡は、ほぼすべて自玉の位置を基点に作成されています。
そして現在のＫＰＰ型では特定の位置でしか行動出来ません。（何億ものパラメタが奇跡的に均等に配分されるわけ無いから）

具体例
浮かむ瀬は６八玉と４二玉の配点が高いです。よってここから進化を辿ったelmo評価関数や、やねうら評価関数は同じです。
wcsc27tanuki-は６九玉や４一玉がelmoより高いです。

ここで問題があります。
例えばelmoは上記の玉位置配点が高いため、この位置に来ると悪手になる戦法を選択されると何度でも必敗型に突っ込んできます。
私が試しにスナイパー定跡を作ってみたところ必勝となりました。（将棋ソフト開発者の言う、なぞり型スナイパー定跡とは違う）
よって、こういった部分は見つけ次第専用定跡で回避しなければなりません。

ですから、elmo評価関数のレートが高いからといって、wcsc27tanuki-評価関数が劣っているとは私は思いません。

そしてelmo-qhapaq評価関数はelmo評価関数と玉位置の配点が異なるため、elmo定跡ではない専用定跡を作成しなければなりません。

また、現在tanuki-さんが作られている互角局面集は、elmo評価関数を使って指し手選別していますので、elmoの玉位置から見る互角の局面集となるかと。

開発者のTwitterにて「誰々の定跡が合わない」とか良く見ますが、対局されているソフトの玉位置の配点をしっかり認識してから考えると分かると思います。
（厳密には玉＋飛車＋角の位置配点で決定されますが、難しすぎるのでとりあえず玉位置だけで良いと思います）

