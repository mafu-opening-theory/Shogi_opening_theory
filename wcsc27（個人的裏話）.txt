第27回世界コンピュータ将棋選手権、本当に楽しく視聴させていただきました。
定跡を作成している目線で見るちょっとした裏話（個人的な）をちょっと書いてみます。


■５月３日
かれこれ半年程、将棋ソフトの序盤に改良の余地があると提唱し続けてきたし、どんな将棋ソフトが出てくるんだろう？
Qhapaqさんとか真面目に定跡作成していたし楽しみだな。
こんな傍観者気取りで見始めました。

一次予選が始まる。
大合神クジラちゃんがまんま「まふ定跡」を使ってる！
しかも初戦がelmoじゃん。floodgateのmonkeymagicだろ？まふ定跡もスナイプされていたので、ver11開発過程でいくつか修正しといたけど。
うわっ！めっちゃelmoにスナイプされてるし。
クライアントとかすごい人数がＰＣつなげて対局しているのか。あっさり負けて申し訳ないな。
その後外出から帰宅すると調度tanuki-戦。しかも２回戦目から連勝してるし。
よくよく見るとtanuki-もまふ定跡やないかーい。
※Readme（開発者向け 5）にも書いている通り、まふ定跡は後手はわりと適当。先手有利で作っています。
おそらく先後が逆ならtanuki-が勝っていたと思うくらいには、tanuki-は強いソフトです。
そんなソフトがelmoとクジラちゃんに負けただけで一次予選通過ギリギリラインとか過酷すぎる。
そして本譜の１１９手目▲７五桂！tanuki-さんを絶叫？させたすごい１手が出ました。

他にはクジラちゃん最終戦のHoneyWaffleとの対局が印象的。
先手早石田に急戦で対抗した形。
たしか「二歩千金」さんのブログでも掲載されていた対抗だったと思いますが、それを私なりにアレンジした戦法定跡進行でした。
※この定跡進行が私のアレンジしたヶ所までHoneyWaffleさんに入っていたので、結構しっかり定跡を作っているなと思いました。

しかしクジラちゃん、elmoに負けただけで２位通過で二次予選か。
明日のシード組がまふ定跡の対策してないとは思えない。
クライアントとかすごい人数が参加しているし、ちょっとがんばってみるか。

そして出来たのが「一発屋定跡」これ修正するのにこの日徹夜しました。
・後手番は相手がスナイプしてきそうなルート進行の場合定跡を切って力戦模様に調整。
・先手番は難解なルート進行を多めに調整。


■５日４日
二次予選が始まる。
大合神クジラちゃん持ってるなと思いました。
定跡を修正したけど、シード組の猛者は大会中に定跡修正するくらいやってのけるし、初戦がまふ定跡のスナイプ定跡を公言していたQhapaqさんでしたから。
最終的にQhapaqさんは８位タイの５勝４敗でソルコフ順位？で１０位となり決勝リーグに行けなかったので。
Qhapaqさんも当たりが強く、大合神クジラちゃん、elmo、nozomi、なのは、に負けただけで決勝リーグを逃している。

この日の印象に残った対局は、
1回戦 大合神クジラちゃん - Qhapaq・・・上手くQhapaqが定跡を切ってきてました。
2回戦 蒼天幻想ナイツ・オブ・タヌキ - 大合神クジラちゃん・・・floodgateで何度も見た急戦。しっかり定跡が入っている相手には横歩急戦は損かな。
3回戦 NineDayFever - 大合神クジラちゃん・・・NineDayFeverがマニアックな定跡選択をした。まふ定跡では、ひねり飛車進行で派生対抗が入っていた。
4回戦 大合神クジラちゃん - 習甦・・・floodgateで何度も見た急戦。習甦には入ってなかったみたいですね。
5回戦 大合神クジラちゃん - 読み太・・・まさかの習甦戦に続いて同じ急戦。しかし読み太には対抗定跡が入っていた。この後どうなるの？からのkeepalive
6回戦 技巧 - 大合神クジラちゃん・・・これについてはいろいろ言いたい。
まず調度、公式のニコニコを見ていたんだけど、解説の遠山五段と司会の人が２６手目△２四飛ぶつけを見て「これが定跡ですか」
「まあPonderヒットでも０秒指しになりますし」とか言ってて、思わず「２８手目までノータイムの定跡進行なのにPonderヒットとかあるわけないだろ」
ってＰＣ画面の前で一人ツッコミしました。
※この２６手目△２四飛車は前提が２３手目にあって、通常ここで玉移動か端歩だけど定跡外しを狙う人がマレに▲３八銀をやることがある。
徹夜明けの定跡ファイルＵＰする２０分前に悩みながら調整した指し手だったので、フラフラになりながらやった甲斐があったなと思うと同時に、
まさかこの定跡外しを技巧がやるとは。出村さんシレっとこんなことするんだもんな。（後で見返すと技巧が思考して指してた）
7回戦 elmo - 大合神クジラちゃん・・・これは私の調整漏れで２８手目が疑問手を指した。ちゃんと調整してたら一発入っていたのか？悔やまれる。
8回戦 大合神クジラちゃん - Ponanza Chainer・・・Ponanzaの動きは分からないし、これは単純に１９手目の▲６八玉が悪手です。
9回戦 nozomi - 大合神クジラちゃん・・・nozomiが初手▲６八玉で定跡外しを狙ったのか分かりませんが、定跡が外れませんでした。

9回戦 読み太 - 技巧・・・これは印象的でしたね。
たしかまふ定跡ver7（一番最初に配布したもの）を出したときに、技巧の指し手進行をそのときの読み太が入れていて、私の入れていた２９手目の▲２四歩が
厳しいからと読み太の開発者が定跡を変更したと思うんだけど、そんな半年前の出来事がこうやってノーパソ１台で技巧に一発入れるとは。
定跡が外れたときに技巧が新手を指したので、実は成立するのか？と興味津々で見ていました。結果は読み太快勝。

この日はＧＷ中だし徹夜明けでフラフラのまま子供を連れて外出。
そんな状態だからローラー式の長いすべり台でひざを強打してアザを作って帰宅。
そうしたら大合神クジラちゃんが決勝リーグ行けそうだし。
もう一回がんばってみるか……。
まさかの二徹。
あんな何百人も期待しているとか、やるしかないでしょ。（クジラちゃんに過労で殺されるかと思った）

そして出来たのが「一発屋定跡（改）」
まふ定跡では、先手横歩取りは５八玉がver7からずっと１００％だったけど別に５八玉が絶対手ではなく、他の局面でも好手判断している指し手が多数あるが
配布した回数も５回とか６回とかだし、いろいろ試している段階の指し手があります。
Readme（開発者向け 5）にも書いている通り、先手横歩取りは６八玉のほうが将棋ソフトは強いと思っていると書いています。
ここでいままでずっと１００％の手を変えたら流石にスナイプ出来ないだろうと、そういった調整をしたものが一発屋定跡（改）の正体でした。


■５日５日
実はGitHubにも書いていたのですが、決勝はトーナメントだと思っていました。
クジラちゃんが３位だったので初戦は５位〜８位の誰かだと。
二徹の真っ最中にそれが総当りだと気づいてしまったときの気持ちはお察し下さい。

決勝リーグが始まる

1回戦 大合神クジラちゃん - HoneyWaffle
一次予選で対局した内容から、ちゃんと定跡制御しないとマズイ相手だなと思っていました。
もしも先後が逆だったら角交換四間飛車してくるんじゃないかと予想し、floodgateで角交換四間飛車（＝ＫＫＳ）ばかりやるKKSなんちゃらって名前の棋譜を
引っ張ってきて調整しました。
将棋ソフトはノーマル四間飛車の学習から▲５六歩とやりがちですが、これは向かい飛車にされると非常に困るのは有段者なら常識だと思います。
ですから早めに▲４六歩と突くことを対策としてルート確認しました。
本譜は１７手目の相手がまだ４筋に飛車がいるのに▲４六歩としています。しかしこれでいいんです。
二徹してもう朝の１０時。家族からこの人何してるの？となじられながら就寝しました。

少し寝て起きると4回戦 NineDayFever - 大合神クジラちゃんでした。
二次予選の3回戦で先後まったく同じ対局です。二次予選ではマニアックな定跡を選んだNineDayFever。めちゃくちゃ嫌な予感がする。
でた。まったく同じ出だしからハメられた。定跡切りから「浮かむ瀬」の悪い形へ誘導された。１２手目△６二玉とかないだろ。
これだからレジェンド組は怖い。当たり前のように大会中に定跡いじってハメてくる。完全に作戦負け。クジラちゃんのクラスタ力が無ければ負けてた。

この間に2回戦と3回戦の棋譜を確認。

2回戦 技巧 - 大合神クジラちゃん
二次予選の6回戦では、技巧がまさかの定跡外しを仕掛けて来てたし、どうやって負けたんだろ？
２１手目▲３八金！また定跡外しかっ！
この戦法はver10から入れ始めた所だから、後から追加していこうと思っていたルートで定跡外しをやられた。
この▲３八金は無駄にならない一手で、こういった手で定跡を外されると非常にマズイ。
中盤もクジラちゃんのクラスタより深く寄せの手を読んでいて、さすが技巧です。
序盤、中盤、終盤。どこにも隙なんて無かったよ。

3回戦 大合神クジラちゃん - 蒼天幻想ナイツ・オブ・タヌキ
tanuki-もまた、まふ定跡やないかーい。
たぶん一次予選でまふ定跡同士の対局で良い勝負から終盤の逆転劇で負けたことと、２次予選は自前定跡でアッサリ負けたことから今回まふ定跡を選択したんだろうけど、
定跡ハマりで瞬殺。
※これ大会終わって５月７日にバグが見つかるんだけど、今大会中のtanuki-はまふ定跡（Apery形式）の定跡選択が真逆の順位で拾っていたので、
まふ定跡の最悪の手ばかりを選んで戦ってtanuki-さんは世界５位です。
tanuki-さんは大会直前にやねうら王の最新版にエンジンを載せ替えたり、初日にelmoさんからelmo絞りを聞くと決勝までに１回間に合わせたり超人です。

5回戦 Ponanza Chainer - 大合神クジラちゃん
二次予選じゃまったく良いとこ無しだったので、対Ponanzaを結構まじめに定跡調整しました。
すっごい期待してたんだけど、あれ？定跡切れてる！
原因は分かりませんが、えびちゃん生放送のコメントではクジラちゃんが意思を持ったそうです。（どこのＳＦだよ）

6回戦 大合神クジラちゃん - elmo
elmoには一次予選定跡スナイプされて瞬殺。二次予選でも調整漏れで疑問手を指して負け。
でも夜中にがんばってelmoスナイプ定跡を作った。
正直Ponanzaを二次予選で撃破したelmoだけど、先手ならクジラちゃんのクラスタ力と併せて勝率６０％はあると思ってた。
そして始まったけど、あれ？また定跡切れてる！途中から合流したり裏ルートへ。
えびちゃん生放送のコメントではクジラちゃんが意思を持ったそうです。（だからどこのＳＦだよ）
でも後から振り返れば、不思議なことが起こったんだなって思いました。
もしここで定跡スナイプが発動してelmoにクジラちゃんが勝っていたら、elmoがPonanzaに勝ったとしてもそのソフトの力に疑問符が付いていたかもしれない。
あんなドラマチックな幕引きは無かったかもしれない。

7回戦 大合神クジラちゃん - 読み太
想定外とはことのとで、定跡復活したらelmoスナイプが読み太に炸裂。
まあ途中からここって築地の競り会場だったっけ？オークション会場だったっけ？といった「２０００、２０００」「３０００」「４０００」とか
elmoの評価値を読み上げるtanuki-さんとカツ丼さんの声がね。


それにしても第27回世界コンピュータ将棋選手権、本当に楽しく視聴させていただきました。
出場された開発者の方々はおつかれさまでした。
最後は公式のニコニコを見ていたんですが、独創賞のとき「まふさん」「まふさん」ってコメントがいっぱい流れて来てすごく嬉しかったです。
なんでもやってみるものだなって。

これ書いているの５月８日なんですが、昨日発表された技巧が「まふ定跡」標準採用ですよ！どんなサプライズですか！
まあ発表中はtanuki-さんの修正verをデバックしてたので、気が付いたのは朝だったんですが。（夜に気付いてたら寝れなかったかもしれない）
最近は当初の目的はだいたい達成したし、そろそろ定跡作成も終了かなーって感じだったんですが、良く考えたらmonkeymagicのときからelmoに一回も勝ってない！
elmoはやっぱり今回のヒーローだし、１ヶ月くらいはelmo最強で良いと思う。
でも「まふ定跡技巧版」技巧２でelmoに勝率５０％超えてみせるから。
