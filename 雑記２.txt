■第2期電王戦 二番勝負 第2局 佐藤天彦叡王 vs PONANZA を何処かで詳しく解説している所あるのかな？

いくら匿名性があるとは言え、通常相手がいる（ソフトではなく佐藤名人等の人間相手）ことに批評するのは信条に反するのですが、定跡屋として私の思ったことを少し書いておきます。

まずPONANZAについて、２手目△４二玉は０点ですがそれ以外は完璧でした。本当にすばらしい内容でした。

定跡屋として佐藤天彦叡王に悪手が有るとしたら、１９手目の▲３七銀でしょうね。

後手の持駒：角 
  ９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|v香v桂 ・v金 ・ ・ ・v桂v香|一
| ・v飛 ・v銀 ・v玉v金 ・ ・|二
|v歩 ・v歩v歩v歩v歩v銀v歩v歩|三
| ・ ・ ・ ・ ・ ・v歩 ・ ・|四
| ・v歩 ・ ・ ・ ・ ・ 歩 ・|五
| ・ ・ 歩 ・ ・ ・ 歩 ・ ・|六
| 歩 歩 銀 歩 歩 歩 銀 ・ 歩|七
| ・ ・ 金 ・ ・ ・ ・ 飛 ・|八
| 香 桂 ・ ・ 玉 金 ・ 桂 香|九
+---------------------------+
先手の持駒：角 
後手番

上記の図が１９手目の▲３七銀ですが、ここで私としては▲６八玉以外ありえません。
（▲６八玉にPONANZAが△４四歩等と争点を作ってくれるのなら、そこを目掛けて戦型を組み立てれるから）
先に▲３七銀と決めてしまったことで、PONANZAに守り一辺倒にさせてしまったので、今のソフト相手に勝ち目は無くなった瞬間でしょう。

※wikipediaの早繰り銀では佐藤名人の手順が定跡として掲載されていますが、個人的な考えを言えばこれは様々な変化に対応出来る柔軟な指し手であり、
将棋を面白くするための定跡だと考えています。
大一番では自分の得意とする手順に相手を引き込めるかが重要であって、ちょっと消極的だったなと思いました。

この後、２０手目にPONANZAが△５一銀としましたがこれも定跡手で、これに違和感を感じる人は矢倉や雁木の経験をもっと積んだほうがいいでしょう。

理由は簡単で、銀は横並びor縦並びの形が非常に好形だからです。
※雁木囲いで相手右四間飛車に銀を横並びで受けるイメージが分かりやすいと思います。

１９手目に▲３七銀と３筋からいくぞと早々に態度を表明してしまったので、これに対する最強の守りは△３三銀の横にもひとつ銀を持ってくることです。
つまり銀矢倉が最強の守りとなるので、PONANZAは定跡（棋理）としてそれを目指したということです。

ただし、人間同士の対局で銀矢倉は通常、腰掛け銀から引っ込んでいく場合がほとんであると思います。
この意味で、２０手目△５一銀は非常に大きな意味を持つ１手で、今後の将棋ソフトはこの局面で△５一銀が最善手として出ない場合、評価関数がおかしいと思ったほうが良いです。



■やねうら王開発者のブログが面白かった

「elmoがもたらしたオーパーツについて」これは必見ですね。
さすが何年も将棋ソフトを開発し、トップを走っているだけのことはあるなあと感心しました。

ただ、プログラマーとしての知見に偏った内容だったので、棋譜の中身を見た私の知見を補足しておきます。


＞興味深いことにelmo式で作成した評価関数は、以前の評価関数とは性質が異なるようで、短い時間(1スレッド1手1秒)では以前の評価関数に負け越すこともある。
しかし長い時間になればなるほど以前の評価関数に勝ち越すようになる。(差が開くようになる)

これはその通りです。


＞興味深いことにelmo式で作成した評価関数同士の場合は、短い時間(1スレッド1手3秒)と、長い時間(1スレッド1手10秒)とで勝率にはそんなに差がないようである。

少しズレているかもしれませんが「elmo-qhapaq評価関数」は３０００万ノードと４０００万ノードでは指し手がかなり違います。


＞dsig = (eval_winrate -t) + 0.5 * (eval_winrate ? teacher_winrate);
tはこの局面の手番側が最終的に勝っているなら1(勝率100%)、負けているなら0(勝率0%)とする。
教師局面の生成時にはdepth 6以上の深さで探索をして、その指し手で局面を進めているのでゲームの結果である勝敗はそこそこ妥当な結果であるから、
これを補正項として用いると過学習を避けられるようである。

具体的に何が起こるか１つ言語化してみると、
elmoの元になった「浮かむ瀬」では、depth 6の範囲は指し手が合流するから同じ評価値を返します。
例）玉が遠いけど、どうせ穴熊になるんだから今△９二香車と上げようが評価値は同じ。
しかし私から見れば、そのタイミングで△９二香車は強引な戦法で切り込める余地が有る場合が有ります。

この①②③④⑤⑥の手順に評価値の差が付いています。

おそらく何十億局面という中で、①②③④⑤⑥なら勝ったけど①④③②⑤⑥の手順だと③のときに何かまずい変化があって負けたとか、そういう差があるのでは？

これが実戦でどうなるかと言えば、危なっかしい手順が減っているので自然な指し回しで勝っている様に人間の目では見えるでしょう。

また、上記は守りを主体に例をあげましたが、攻めの場合も当然手順に評価値が直っていることになるので、計らずして手筋的概念を学習していると思います。

RootStrap方式でも投了値３０００とかなので同じ結果になりそうな物だけど、これは確実に違うと断言しておきます。
※「浮かむ瀬」の序盤を半年間ダメ出しをしてきたのですぐに気が付きました。ただし、かなりの頻度で直っているもののまだたくさん残っています。
そういった意味でも「elmo」の評価関数にまだ改良の余地が有ります。



■いろんな理論が飛び交っていて面白いですね

qhapaq開発者「elmo型学習の特徴と短い持ち時間で強くない理由 in elo河童理論」読みました。
私には難しい理論は良く分かりませんが、読んでいて「ん？」と思ったことを書き散らしておきます。

前提として、そもそも今の将棋ソフトはアルファ・ベータ法や反復深化深さ優先探索を用いて、擬似的に高効率で完全探索結果を出力しているのであって、
実際は完全探索から程遠い最善手の出力でしょう。（将棋の分岐局面数が非常に多いため）
それをさらに絶対手へと近づけるために、ＫＰＰと特徴量を定義した精度の高い評価関数を用意し、その数値の点を探索部で勝利に向かって線として結んでいるのでは？

ですから、
＞指し継がせた勝率が深い読みの評価値より教師として適切であることは、実は自明ではないのですが、elmoが強くなっている以上、正しいと見なすことにします。

指し継がせた勝率が深い読みの評価値より教師として適切なのは当たり前なんじゃないんですか？

浅い探索といっても、今の将棋ソフトのdepth 6はアマチュア有段者の棋力です。
そのレベルで何十億局面も生成して勝ったか負けたかを検証した指し手評価のほうが、１静止局面から擬似的に完全探索モドキで出力された指し手より正確であるのは当たり前だと思います。


あとTwitterにて、
＞（余談）あと、今までの雑巾絞りの教師の深さdepth依存性（誰かが明文化してるわけではないけど、経験則的にdepth 6以降はあんまり変わらないようです）からも、
depth 6の指し継がせの勝率は十分な数があれば真の勝率に近づくと思われます。

これ将棋ソフトの棋譜の中身を見切れる人は説明出来るんですけど、書くと開発環境が大きい（計算リソースが豊富）所が有利になってしまうので書きません。



■elmo評価関数

elmo開発者のTwitterにて、
＞雑巾絞りって「評価値が近くて、異なる局面を拾ってきてグリップを効かせる処理」だと思ってます。だから自分のイメージは凄く正則化項で。
その解釈でもサンプルが少ない＝ノイズが多い(ベイズ的な意味で)なので、正則化項強くしたほうが良いっていう解釈は合致します。
＞あ違うか。ノイズの期待値は数で変わんないや。ただ数が少ないと特徴量毎に勝ち負けが偏り易いので良くないとかそんな気はする。
＞正則化項という言葉の使われ方をしているので、学習中の評価関数での数手読みとの交差エントロピーロスの方がよりイメージに合うのかなとか思ったのですが、もしかして試されていますか?
＞はい、僕もそうしたかったのですがやってみると悪化しました。収束しなくなるようです。fixed target Q-learningとかを見ると固定しないと駄目なのかなと思って以降あまり検討してないです。
＞うーむ収束しなくなってしまうんですか。元の評価関数の数手読みって、元の評価関数を色濃く残してしまいそうなんですが、逆にそれが良い方に働いているんですかねぇ

以前、Readme（開発者向け 6）.txt１６１行目から書いていた通り、私の目からは「elmo」＝「進化した浮かむ瀬」です。
なので、１７０行目には「elmo絞りは現行の評価関数の仕上げ作業が出来るのではないかと考えています」と書きました。

レーティングが全然違うじゃないかと思われるかもしれませんが、
Ukamuse sdt4は３６６８（定跡ＯＦＦ）で浮かむ瀬と同等の探索部レベルで計算すると、３９７８（定跡ＯＦＦ）－１５０＝３８２８程度で、
評価関数単体の差は３８２８－３６６８＝Ｒ１６０程度でしょう。

Ｒ１６０＝勝率７２％ですから、
まふ定跡v9　対局データを見て分かる通り、チョロっと上手く指させた程度の差しか有りません。

つまり「浮かむ瀬」の評価関数の完成度がかなり良い所まで到達していて、elmo絞りで最後のアシストをした。が正解です。

将棋ソフト開発者らの意見を見ていると、elmo絞りの根本的な部分を見落としているように感じます。
（勝率や数値だけをいじくりまわして、最終的に反映された将棋の中身がどう変わったのか理解出来ていないから、変な幻想にハマってる？）



■気になったので書いておく（うろ覚えの持論です）

将棋の勝率って、人間の対局も将棋ソフト同士の対局もおおむね、先手勝率５３％程度、後手勝率４７％程度だったと思う。

今回「まふ定跡戦型別」を配布するにあたって、GitHubに書いた通りその時のfloodgate最新（今回は第４回電王戦以降～2017年5月21日までの上位ソフト）
の良さそうな棋譜約４０００局程度おまけで入れました。

そして仕分けしていて気が付いたことは、wcsc27以降のソフト（Ｒ３８００超え）の対局のみをワンサイドゲームっぽい棋譜で仕分けしてみたところ、
先手勝率５８％程度、後手勝率４２％程度になった。

初めは定跡による誤差だな。と思っていましたが、Ponanzaの下山さんのTwitterとか思い出すとちょっと待てよとなりました。
https://twitter.com/ak11/status/738385596977139712
このグラフを見るに評価値１００≒勝率６０％であり、１手の価値を１００点と仮定した場合、かなり近い値なのではないかと思いました。

つまり、Ｒ３８００超えの領域においては先手勝率５８％程度、後手勝率４２％程度が真の値で１手の価値は勝率約８％なのでは？

うろ覚えですが、チェスはポーン（≒歩）を１００点として、４００点差が開いたらほぼ勝利を確信みたいな感じだったと思う。
現在の将棋ソフトもその構想を取り入れて評価値を構成していたと思う。
Ponanzaも何かの関数に６００点という数字を使っていたはず。
数字に強いqhapaq開発者も河童絞りにおいて、評価値７００差で学習を終わらせると設定されています。

よって、第５回電王戦で予想される将棋ソフトのトップレートであるＲ４０００超えの領域においては、評価値６００点の差がついたらほぼ勝敗は決している状態。

もちろん１手＝１００点と仮定しても１マス以上動ける駒が存在するし、歩の価値は最も大きく変動するので固定出来るような数値ではありません。
ただ、今後の将棋ソフトが強くなるためには、この辺の構想を上手く反映して６００点を先に取れることがポイントになるかもしれません。

追記
駒落ちについて、
例えば飛車の価値が平手で６００点だとすると、飛車落ちは勝率９３％から始まり、残りの７％の逆転を許さない棋力があれば必勝となる。
と仮定した場合、駒落ちの限界レートが存在するのでは？